# Development compose with live reload
#
# Usage: docker compose -f docker-compose.dev.yml up
#
# Frontend: Vite dev server with hot reload on port 5174
# Backend: Rust source mounted for rebuild via `cargo build` inside container
#
# To rebuild the backend after code changes:
#   docker compose -f docker-compose.dev.yml exec backend cargo build --release
#   docker compose -f docker-compose.dev.yml restart backend

services:
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: ztp-frontend-dev
    networks:
      - ztp-net
    ports:
      - "5174:5173"
    volumes:
      - ./frontend:/app
      - ./shared:/shared
      - /app/node_modules
    environment:
      - VITE_API_URL=http://backend:8080
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build:
      context: ./backend-rust
      dockerfile: Dockerfile.dev
    container_name: ztp-backend-dev
    hostname: ztp-server
    networks:
      ztp-net:
        ipv4_address: 172.30.0.2
    ports:
      - "8080:8080"
    volumes:
      - ./backend-rust/src:/app/src:ro
      - ./backend-rust/Cargo.toml:/app/Cargo.toml:ro
      - ./backend-rust/Cargo.lock:/app/Cargo.lock:ro
      - ./backend-rust/scripts:/scripts:ro
      - cargo-registry:/usr/local/cargo/registry
      - cargo-target:/app/target
      - dev-data:/data
      - dev-tftp:/tftp
      - dev-backups:/backups
      - ./configs/templates:/configs/templates:ro
      - /var/run/docker.sock:/var/run/docker.sock
    cap_add:
      - NET_ADMIN
    environment:
      - DB_PATH=/data/ztp.db
      - TFTP_DIR=/tftp
      - BACKUP_DIR=/backups
      - TEMPLATES_DIR=/configs/templates
      - RUST_LOG=debug
      - DOCKER_NETWORK=ztp-app_ztp-net
      - TEST_CLIENT_IMAGE=ztp-server-test-client
    restart: unless-stopped

  test-client:
    build:
      context: ./test-client
      dockerfile: Dockerfile
    container_name: ztp-test-client
    hostname: test-switch
    networks:
      ztp-net:
        ipv4_address: 172.30.0.99
    mac_address: "02:42:ac:1e:00:99"
    cap_add:
      - NET_ADMIN
    depends_on:
      - backend
    profiles:
      - test

networks:
  ztp-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1

volumes:
  cargo-registry:
  cargo-target:
  dev-data:
  dev-tftp:
  dev-backups:
